---
title: That's COOL AS FUCK
description: Structuring files as an editor
navigation:
  icon: i-lucide-heading-1
---



::code-preview{class="[&>div]:*:my-0 [&>div]:*:w-full"}
:::code-tree{default-value=".bruin.yml"}
```yaml [.bruin.yml]
default_environment: default
environments:
    default:
        connections:
            postgres:
                - name: pg-default
                  username: postgres
                  password: postgres
                  host: localhost
                  port: 5432
                  database: postgres
            duckdb:
                - name: duckdb-default
                  path: duckdb.db
````

```yaml [glossary.yml]
domains:
  customer-management:
    description: All aspects related to customer data, registration, and account management
    owners:
      - "Data Team"
    tags:
      - customer
  product-catalog:
    description: Product and catalog data including variants and SKUs
    owners:
      - "Data Team"
    tags:
      - product
      - catalog
  sales:
    description: Orders and order items lifecycle data
    owners:
      - "Data Team"
    tags:
      - sales

entities:
  Base:
    description: Required fields for every Ingestion/Staging step.
    attributes:
      ID:
        name: id
        type: integer
        primary_key: true
        description: The unique identifier in our systems.
        checks:
          - name: not_null
          - name: unique
      CreatedAt:
        name: created_at
        type: timestamp
        description: Timestamp when the record was created.
        checks:
          - name: not_null
      UpdatedAt:
        name: updated_at
        type: timestamp
        description: Timestamp when the record was last updated.
        checks:
          - name: not_null
  Customer:
    description: Customer is an individual/business registered on our platform.
    domains:
      - customer-management
    attributes:
      ID:
        name: customer_id
        type: integer
        checks:
          - name: not_null
          - name: unique
      Email:
        name: email
        type: string
        checks:
          - name: not_null
      FullName:
        name: full_name
        type: string
      Country:
        name: country
        type: string
      Age:
        name: age
        type: integer
        checks:
          - name: range
            min: 0
```

```yaml [orders-performance/pipeline.yml]
name: ecommerce_pg_to_duckdb

default_connections:
  duckdb: "duckdb-default"
  postgres: "pg-default"

variables:
  all_time:
    type: int
    default: 1 # 0 for all time - 1 to enable start_date and end_date
```

```yaml [orders-performance/assets/ingestion/raw.customers.asset.yml]
name: raw.customers
type: ingestr
description: Ingest OLTP customers from Postgres into DuckDB raw layer.

parameters:
  source_connection: pg-default
  source_table: "public.customers"
  destination: duckdb

columns:
  - extends: Base.ID
  - extends: Customer.FullName
  - extends: Customer.Email
  - extends: Customer.Country
  - extends: Customer.Age
  - extends: Base.CreatedAt
  - extends: Base.UpdatedAt
```

```yaml [orders-performance/assets/ingestion/raw.orders.asset.yml]
name: raw.orders
type: ingestr
description: Ingest OLTP orders from Postgres into DuckDB raw layer.
tags:
  - orders
  - amazing-tag
depends:
  - stg.customers
owner: danielhe4rt@gmail.com

parameters:
  destination: duckdb
  source_connection: pg-default
  source_table: public.orders

columns:
  - extends: Base.ID
  - extends: Order.CustomerID
  - extends: Order.OrderDate
  - extends: Order.Status
  - extends: Order.TotalAmount
  - extends: Base.CreatedAt
  - extends: Base.UpdatedAt
```

```sql [orders-performance/assets/mart/customers/mart.customers_by_age.asset.sql]
/* @bruin
name: mart.customers_by_age
type: duckdb.sql
tags:
  - mart
  - amazing-tag
materialization:
  type: table
  strategy: create+replace
depends:
  - stg.customers
owner: danielhe4rt@gmail.com
@bruin */

WITH src AS (
  SELECT CASE
            WHEN age < 25 THEN '18-24'
            WHEN age BETWEEN 25 AND 34 THEN '25-34'
            WHEN age BETWEEN 35 AND 49 THEN '35-49'
            ELSE '50+'
         END AS age_group
  FROM stg.customers
)
SELECT age_group,
       COUNT(*) AS total_customers
FROM src
GROUP BY age_group
ORDER BY total_customers DESC;
```

```sql [orders-performance/assets/mart/products/mart.product_performance.asset.sql]
/* @bruin
name: mart.product_performance
type: duckdb.sql
materialization:
  type: table
  strategy: create+replace
depends:
  - stg.products
  - stg.product_variants
  - stg.order_items
  - stg.orders
@bruin */

WITH paid_items AS (
  SELECT oi.*
  FROM stg.order_items oi
  JOIN stg.orders o ON o.order_id = oi.order_id
  WHERE o.status IN ('paid','shipped')
),
items_with_product AS (
  SELECT
    v.product_id,
    oi.quantity,
    oi.total_price
  FROM paid_items oi
  JOIN stg.product_variants v ON v.variant_id = oi.variant_id
)
SELECT
  p.product_id,
  p.name AS product_name,
  p.category,
  SUM(i.quantity) AS items_sold,
  SUM(i.total_price) AS gross_revenue,
  CASE WHEN SUM(i.quantity) = 0 THEN 0 ELSE SUM(i.total_price) / SUM(i.quantity) END AS avg_item_price
FROM items_with_product i
JOIN stg.products p ON p.product_id = i.product_id
GROUP BY 1,2,3
ORDER BY gross_revenue DESC;
```

```sql [orders-performance/assets/staging/stg.customers.asset.sql]
/* @bruin
name: stg.customers
type: duckdb.sql
materialization:
  type: table
depends:
  - raw.customers
@bruin */

SELECT
  id::INT AS customer_id,
  COALESCE(TRIM(email), '') AS email,
  COALESCE(TRIM(country), 'Unknown') AS country,
  COALESCE(age, 0) AS age,
  created_at,
  updated_at
FROM raw.customers
WHERE email IS NOT NULL;
```

:::
